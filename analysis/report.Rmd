---
title: "ETC1010-5510 Project - T11_Wed_skimr"
subtitle: "A Report On The LinkedIn-World Bank Data for Development"
author: "Hanchen Wang 30704456, Hao Li 32041594, Jiaying Zhang 30930685, Mohammed Faizan 31939872, Karan Garg 32106580"
date: "28 April 2021"
output: 
  bookdown::html_document2
keep_md: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

#loading packages

library(tidyverse) 
library(plotly)
library(naniar)
library(visdat)
library(bookdown)
library(knitr)
library(ggplot2)
library(lubridate)
library(geosphere)
library(ggmap)
library(ggthemes)
library(maps)
library(patchwork)
library(here)
library(readxl)
library(readr)
```
#QUESTIONS

Q1) Which skill category is most common across all Industry Sections and how does it vary between each section? **(Hao Li)**

##data description: The data is about what skills are needed most in different industries
## Question1. Which skill category is most common across all Industry Sections and how does it vary between each section? 

The most common skill category across different sections is Business Skills. 

```{r, fig.width=8,fig.height=4}
mydat <- read_excel('5510public_use-industry-skills-needs clean.xlsx', 
                    sheet = 'Industry Skills Needs')

mydat$industry_name <- as.factor(mydat$industry_name)
mydat$isic_section_name <- as.factor(mydat$isic_section_name)
mydat$skill_group_category <- as.factor(mydat$skill_group_category)

##TABLES:
#skill category frequency by industry section:
mydat %>% 
  group_by(isic_section_name) %>%
  count(mydat$skill_group_category) %>% arrange(desc(n))

#top 1 skill in every industry section:
section_top1 <- mydat %>% 
  count(isic_section_name,skill_group_category ) %>%
  arrange(desc(n)) %>% 
  group_by(isic_section_name) %>% 
  slice(seq_len(1)) 

##PLOTS:
#set consistent color scheme:
skillColors <-
  setNames( c('wheat4', 'coral', 'azure','lightpink4','thistle4')
            , levels(mydat$skill_group_category)  )

#plot bar chart across inductry section:
ggplot(section_top1, mapping = aes(x=isic_section_name,y=n,fill=skill_group_category))+geom_bar(stat = 'identity')+xlab('Industry Section')+ylab('Frequency')+ggtitle('Most Common Skill Category by Industry Section')+scale_fill_manual(values = skillColors)+coord_flip()
```

From the bar chart above, we can see the most common skill category within each industry section. Specialized Industry Skills are the most common skill category in 4 out of 6 industry sections. Tech skills are the most common within Information and Communication, Business Skills are the most common within Financial and Insurance Activities. 

```{r,fig.width=9,fig.height=4}
#skill category frequency by industry section - descending order:
section_topn <- mydat %>% 
  count(isic_section_name,skill_group_category ) %>%
  arrange(desc(n)) %>% 
  group_by(isic_section_name) %>% 
  slice(seq_len(5)) 

#Get the levels for type in the required order
section_topn2 <- arrange(section_topn,desc(skill_group_category))

#Calculate the percentages
library(plyr)
section_topn2 <- ddply(section_topn2,.(isic_section_name),transform, percent = n/sum(n) * 100)

#Format the labels and calculate their positions
section_topn2  = ddply(section_topn2,.(isic_section_name),transform, pos = (cumsum(n) - 0.5 * n))
section_topn2$label = paste0(sprintf("%.0f", section_topn2$percent), "%")

#Plot
ggplot(section_topn2, aes(x = isic_section_name, y = n, fill = skill_group_category, label=label)) +
  geom_bar(stat = 'identity', position = position_fill()) +
  geom_text(position = position_fill(vjust = .5)) + ggtitle('Skill Category Distribution by Industry Section')+ylab('percent')+xlab('Industry Section')+scale_fill_manual(values = skillColors)+coord_flip()
```
The above 100% stacked bar chart shows the skill category distribution within each industry section. While 4 out of 6 industry sections have a similar skill category distribution, Financial & Insurance Activities and Arts, Entertainment & Recreation have a rather different skill category distribution. Business skills are greatly needed (61%) while Tech skills are much less needed comparably for Financial industry. Specialized skills(53%) and Tech skills(24%) are majorly needed for Arts and Entertainment industry while Business skills (6%) and Disruptive Tech skills (0)are the least needed types for the industry section. 


2) **What is the average percentage of net migration for each industry over the past five years and Is the growth rate of immigration within the industry related to the growth rate of the industry?**

olddata

In the first part of my question data migration_industry (5,295 × 30) is used. The variables industry and industry section's name,id net migration rate per year is chosen, renamed, and change format final(26,475×4). In the second part of the question  original data is 3_Employment_Growth 
(14,144 ×13). I picked industry id, name and the rate of industry's improvement in each year. I use industry_id and year are used as
```{r read-data}
mgindustry <- read_csv(here::here("data/migration_industry.csv"))
growindustry<- read_csv(here::here("data/3_employment_growth.csv"))
```
```{r datacleaning, include=FALSE}
mgpick <- mgindustry %>% 
  select(industry_name,
         industry_id,
         isic_section_index,
         isic_section_name,
                net_per_10K_2015,
                net_per_10K_2016,
                net_per_10K_2017,
                net_per_10K_2018,
                net_per_10K_2019)
growpick <- growindustry %>% 
  select(industry_name, 
         industry_id,
                growth_rate_2015,
                growth_rate_2016,
                growth_rate_2017,
                growth_rate_2018,
                growth_rate_2019)

```
#average percentage of net migration for each industry over the past five years

```{r mgdatause}
mguse<- mgpick %>% 
   rename(c("2015"= "net_per_10K_2015",
           "2016"= "net_per_10K_2016",
           "2017"= "net_per_10K_2017",
           "2018"= "net_per_10K_2018",
           "2019"= "net_per_10K_2019",
           "industry" = "industry_name",
           "industry_section"= "isic_section_index",
           "section_name" = "isic_section_name")) %>% 
    pivot_longer(cols = 5:9,  
               names_to = "year",            
               values_to = "net_migration_rate") %>% 
 mutate(migration_year= year,
        migration_industry_id = industry_id) %>% 
 unite("industry_year", migration_industry_id, year)
```
```{r mgave}
mgave <- mguse %>% 
  group_by(industry_year) %>% 
  summarise(average_migration_rate = mean(net_migration_rate, na.rm = TRUE),
            industry_section_index = industry_section) 
```
```{r mgfinal}
mgfinal <- mgave %>% separate(industry_year,
           c("industry","year"), "_") %>% 
  mutate(year = as.numeric(year)) %>% 
  group_by(industry_section_index)
```

#Is the growth rate of immigration within the industry related to the growth rate of the industry?

```{r relationdata}
growuse <- growpick %>% 
   rename(c("2015"= "growth_rate_2015",
           "2016"= "growth_rate_2016",
           "2017"= "growth_rate_2017",
           "2018"= "growth_rate_2018",
           "2019"= "growth_rate_2019"
           )) %>% 
    pivot_longer(cols = 3:7,  
               names_to = "year",            
               values_to = "growth_rate") %>% 
 unite("industry_year", industry_id, year)
growclean <- growuse %>% 
  mutate(growth_rate = str_sub(growuse$growth_rate,start = 1, end = -2))%>% 
  mutate(growth_rate = as.numeric(growth_rate)) %>% 
  na.omit()
```

```{r growave}
growave <- growclean %>% 
  group_by(industry_year) %>% 
summarise(average_grow_rate = mean(growth_rate, na.rm = TRUE))
```
```{r full}
fulldata<- mgave %>% 
  inner_join(growave, by="industry_year")
```

```{r finaldata}
cleandata <- fulldata %>% separate(industry_year,
           c("industry_section","year"), "_") %>% 
  mutate(year = as.numeric(year)) %>% 
  unique()
```

3) **For each common skill_category, which industry has the highest penetration rate and what is the change of the common skill penetration rate over the period of time?**


# Data Descripion

“2_skill_penetration.csv” is the data showing skill profiles for each global industry and penetration of LinkedIn skill groups at the global industry level from 2015 to 2019, which penetration means the weight of one skill occupied each industry.

The old data (“2_skill_penetration.csv”) is 30,740 × 7 variables and the cleaned clean data (“2_skill_penetration_clean.csv”) is 4156 × 9.

```{r read data}
penetration_raw <- 
  read_csv(here::here('data/2_skill_penetration.csv'))

```


```{r data cleaning}
penetration_clean <- penetration_raw %>% 
  select(!isic_section_index) %>% 
  pivot_wider(names_from = year, 
              values_from = skill_group_penetration_rate) %>% 
  select(skill_group_category:"2019") %>% 
  rename(penetration_rate_2015 = "2015", penetration_rate_2016 = "2016", 
         penetration_rate_2017 = "2017", penetration_rate_2018 = "2018", 
         penetration_rate_2019 = "2019", section_name = isic_section_name) %>% 
  na.omit() %>% 
  mutate(penetration_rate_2015 = as.numeric((unlist(penetration_rate_2015))), 
         penetration_rate_2016 = as.numeric((unlist(penetration_rate_2016))), 
         penetration_rate_2017 = as.numeric((unlist(penetration_rate_2017))), 
         penetration_rate_2018 = as.numeric((unlist(penetration_rate_2018))), 
         penetration_rate_2019 = as.numeric((unlist(penetration_rate_2019)))
         )


```

```{r export cleaned data}
write.csv(penetration_clean, here::here("data/2_skill_penetration_clean.csv"))
```

4) **Find the industry_section that is best to each region/continent.**

Q5) Which industry_name sees the maximum growth over time in each region/continent , depending on the region’s best industry_section ? **(Mohammed Faizan)**


# EDA

```{r reading_data}

skills_raw <- read_excel(here::here('data/1_skills.xlsx'), sheet=4)
penetration_raw <- read_excel(here::here('data/2_skill_penetration.xlsx'), sheet=4)
emp_growth_raw <- read_excel(here::here('data/3_employment_growth.xlsx'), sheet=4)


```

```{r}
# tidy emp_growth_raw

temp <- emp_growth_raw %>% select(starts_with("growth")) %>% names()
emp_growth_raw_long <- emp_growth_raw %>%
                          pivot_longer(cols = all_of(temp), 
                                       names_to = "year", 
                                       values_to = "growth_rate") %>%
                      separate(year, into = c("temp1","temp2","year"), convert = TRUE) %>%
                      select(-starts_with("temp"))
head(emp_growth_raw)
```

```{r}
#some summaries
#joining skills and penetration data

skill_penetration_common <- skills_raw %>%
                            inner_join(penetration_raw,
                                       by=c("year"="year",
                                          "isic_section_index"="isic_section_index",
                                       "isic_section_name"="isic_section_name",
                                       "skill_group_category"="skill_group_category",
                                       "skill_group_name"="skill_group_name",
                                       "industry_name"="industry_name")
                                       ) %>%
                            select(-isic_section_index)

#some summaries
unique(skill_penetration_common$year)
unique(skill_penetration_common$isic_section_name)
unique(skill_penetration_common$skill_group_category)

#all skills required by all industries except for mining and quarrying which does not require disruptive tech skills. soft skills importance remains same across industy sections.
skill_penetration_common%>%ggplot()+geom_count(mapping = aes(x=isic_section_name,skill_group_category))+theme(axis.text.x = element_text(angle = 60))
```

```{r }

industry_info <- skill_penetration_common %>% select(isic_section_name,industry_name) %>%
                  group_by(isic_section_name) %>% count(industry_name) %>% select(-n) %>%
                  ungroup()

industries <- industry_info%>%pivot_wider(id_cols= c(isic_section_name, industry_name), names_from = isic_section_name, values_from = industry_name)
industry_info%>%ggplot()+geom_bar(aes(x=isic_section_name))+coord_flip()+labs(title = "Industry Count within each Section")
```

```{r}

skills_info <- skill_penetration_common %>% select(skill_group_category,skill_group_name) %>%
                  group_by(skill_group_category) %>% count(skill_group_name) %>% select(-n) %>%
                  ungroup()
skills <- skills_info%>%pivot_wider(id_cols= c(skill_group_category, skill_group_name), names_from = skill_group_category, values_from = skill_group_name)
skills_info%>%ggplot()+geom_bar(aes(x=skill_group_category))+coord_flip()+labs(title = "Skill Count within each Skill Category")
```

```{r eda_emp_growth}
pct_miss(emp_growth_raw_long) #no missingness
length(unique(emp_growth_raw_long$country_name))
unique(emp_growth_raw_long$wb_region)
unique(emp_growth_raw_long$wb_income)
unique(emp_growth_raw_long$isic_section_name)
unique(emp_growth_raw_long$year)

```

```{r}

gfun <- function(x){
  temp <- emp_growth_raw_long%>%filter(year==x)
  return(temp)
}
emp_growth_yearwise <- list(gfun(2015),gfun(2016),gfun(2017),gfun(2018),gfun(2019))

```


```{r}
#for each region, every year there same number of records for each industry_section
emp_growth_raw_long%>%count(wb_region,isic_section_name,year)%>%pivot_wider(id_cols = c(year,n,wb_region,isic_section_name),names_from = year, values_from=n)

emp_growth_raw_long%>%count(wb_region,isic_section_index,year)%>%ggplot()+geom_col(mapping = aes(x=isic_section_index,y=n,fill=as.character(year)),position ="dodge")+facet_wrap(~wb_region)#+theme(axis.text.x = element_blank())

#presence of industries in each region
emp_growth_raw_long %>%
  ggplot()+geom_count(mapping=aes(x=wb_region, y=isic_section_name))+theme(axis.text.x = element_text(angle = 45))



```


Q6) For each region, which country did the above found industry had had maximum growth? And, what is the income group of that nation? **(Karan Garg)**

```{r read-data,include=FALSE}
growth <- read.csv(here::here("data/industry-employment-growth.csv"))
```

```{r clean_data,include=FALSE}
growth_tidy <- growth %>% 
  pivot_longer(cols = 9:13,
               names_to = "year",
               values_to = "growth_rate") %>% 
  separate(year,into=c("temp1","temp2","year"),sep = "_") %>% 
  select(-c(temp1,temp2))

  
```

```{r write-data}
write.csv(growth_tidy,here::here("data/industry-employment-growth-cleaned.csv"))
```

# Data Descripion

This Data describes the Industry wise Employement growth across the years from 2015-2019. It further showcases the growth rate depending upon various variables such as Country, Region/Continentm, Industry Section and within each section variioous Industries.

The dimensions of the cleaned data set are 36675 X 10.